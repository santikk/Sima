<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to the simulation framework • Sima</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to the simulation framework">
<meta property="og:description" content="Learn how to define events and to get started with building your own simulator.
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Sima</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/Sima.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to the simulation framework</h1>
            
      
      
      <div class="hidden name"><code>Sima.Rmd</code></div>

    </div>

    
    
<p>The goal of the package is to provide a framework for defining simulators for a variety of purposes and applications in the health care domain. Several design choices have been made to make the simulator as general as possible, highly scalable and easy to use. The package also provides tools to calibrate the simulator according to chosen metrics.</p>
<p>The simulators created by the package are dynamic and operate on the individual level with a fixed-increment time progression where the synthetic population is subject to reoccurring events governed by stochastic processes.</p>
<div id="population-fundamentals" class="section level2">
<h2 class="hasAnchor">
<a href="#population-fundamentals" class="anchor"></a>Population fundamentals</h2>
<p>To define a simulator, an initial population and a list of events are required. The initial population can be defined directly from real data, or it can be synthetic. In R, the population should be defined as a <code>data.table</code> with a row for each individual and each column corresponding to a status variable. There are no restrictions on the population, except that a column named “alive” must always exist in the table, with values 0 and 1 indicating whether the individual is alive or not. The simulator also uses a status variable called “last_event” to denote which event was applied last before the individual died. This can be used for example to determine the cause of death in the case where the simulator contains multiple events that are able to cause mortality.</p>
</div>
<div id="event-fundamentals" class="section level2">
<h2 class="hasAnchor">
<a href="#event-fundamentals" class="anchor"></a>Event fundamentals</h2>
<p>Events are categorized into two distinct groups: manipulation events and accumulation events. Manipulation events modify the status of the population that is currently still alive in the simulation. This type of events can be for example aging, occurrence of a disease or mortality. Accumulation events on the other hand introduce new individuals to the population while keeping the status of the existing population otherwise intact. Accumulation events can model for example immigration or births. Each event has access to its own set of parameters that can be used to define statistical models and to enable the behavior of the event to be calibrated. Even functionality is essentially defined as an R expression that has access to the status of the synthetic population and the parameters of the event in question.</p>
</div>
<div id="constructing-events" class="section level2">
<h2 class="hasAnchor">
<a href="#constructing-events" class="anchor"></a>Constructing events</h2>
<p>Both types of events are defined as R6 classes with the following constructors</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">ManipulationEvent</span>$<span class="fu">new</span>(<span class="no">name</span>, <span class="no">description</span>, <span class="no">parameters</span>, <span class="no">mechanism</span>)
<span class="no">AccumulationEvent</span>$<span class="fu">new</span>(<span class="no">name</span>, <span class="no">description</span>, <span class="no">parameters</span>, <span class="no">mechanism</span>)</pre></body></html></div>
<p>For both types of events, the arguments of the constructor are defined as follows:</p>
<ul>
<li>
<code>name</code> is a character string that serves as a unique identifier.</li>
<li>
<code>description</code> is an optional argument that provides a text-based explanation about the functionality and purpose of the event</li>
<li>
<code>parameters</code> is numeric vector of parameters</li>
<li>
<code>mechanism</code> is an R expression that defines what the event does.</li>
</ul>
<p>As an example, consider a simulator where events are applied daily and we wish to model the aging of individuals in the population. This can be accomplished with the following manipulation event:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">aging</span> <span class="kw">&lt;-</span> <span class="no">ManipulationEvent</span>$<span class="fu">new</span>(
  <span class="kw">name</span> <span class="kw">=</span> <span class="st">"Aging"</span>,
  <span class="kw">description</span> <span class="kw">=</span> <span class="st">"Aging of individuals"</span>,
  <span class="kw">mechanism</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>({
    <span class="no">status</span>[<span class="no">living</span>, <span class="no">age</span> <span class="kw">:=</span> <span class="no">age</span> + <span class="fl">1.0</span> / <span class="fl">365.0</span>]
  })
)</pre></body></html></div>
<p>In this instance the event does not require any parameters. The logical vector <code>living</code> is always available denoting those individuals that are still alive in the population at the time of evaluation of the event in question. The shortcut <code>par</code> is used to refer to the parameter vector within the <code>mechanism</code> expression. The population <code>status</code> is a <code>data.table</code> so the appropriate syntax is required.</p>
<p>In the case of manipulation events, the <code>mechanism</code> should not have a return value. In the case of accumulation events however, the return value should be a <code>data.table</code> with the same columns as <code>status</code> with each row depicting those individuals that are to be added to the population.</p>
</div>
<div id="constructing-a-simulator" class="section level2">
<h2 class="hasAnchor">
<a href="#constructing-a-simulator" class="anchor"></a>Constructing a Simulator</h2>
<p>The simulator is defined as an R6 class with the following constructor</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">Simulator</span>$<span class="fu">new</span>(<span class="no">initializer</span>, <span class="no">manipulation_events</span>, <span class="no">accumulation_events</span>, <span class="no">time</span>, <span class="no">seeds</span>, <span class="no">...</span>)</pre></body></html></div>
<p>The arguments of the constructor are defined as follows:</p>
<ul>
<li>
<code>initializer</code> is a function that returns the initial population as a <code>data.table</code>.</li>
<li>
<code>manipulation_events</code> is a list of <code>ManipulationEvent</code> objects.</li>
<li>
<code>accumulation_events</code> is a list of <code>AccumulationEvent</code> objects.</li>
<li>
<code>time</code> is an object of R6 class <code>Time</code>.</li>
<li>
<code>...</code> are the additional arguments to be passed to <code>initializer</code>
</li>
</ul>
</div>
<div id="calibration" class="section level2">
<h2 class="hasAnchor">
<a href="#calibration" class="anchor"></a>Calibration</h2>
<p>After defining the events and the initial population, the next task is typically to obtain parameter values for the events such that some measure of the synthetic population matches that of an external validation data set as closely as possible. To this end, events with parameters can be configured after initialization. Furthermore, it is possible to run multiple simulations with different parameter configurations while keeping the initial population intact and using the same seed values for the pseudo random number generation each time such that the any difference in output will be purely a result of the varying parameter values.</p>
<p>The <code>Simulator</code> class method <code>calibrate</code> serves as a wrapper for using the standard R optimization tool <code>optim</code> for calibration.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">Simulator</span>$<span class="fu">calibrate</span>(<span class="no">t_sim</span>, <span class="no">events</span>, <span class="no">output</span>, <span class="no">objective</span>, <span class="no">inits</span>, <span class="no">optim_args</span>, <span class="kw">auto</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="no">...</span>)</pre></body></html></div>
<p>The arguments for the method are as follows:</p>
<ul>
<li>
<code>t_sim</code> is the length of the simulation for a single function evaluation in the optimization. The value that should be used is highly dependent on target feature of the calibration, the objective function and the size of population.</li>
<li>
<code>events</code> is a named list of manipulation events and accumulation events that are to be calibrated.</li>
<li>
<code>output</code> is a statistic that should be computed from the synthetic population for each parameter configuration.</li>
<li>
<code>objective</code> is the objective function used in optimization. The first argument of the function should accept the return value of of <code>output</code>. Typically this function compares a summary statistic from <code>output</code> against some external validation data.</li>
<li>
<code>inits</code> is an optional named list of initial parameter values for each event. If no initial values are provided, the current values are used instead.</li>
<li>
<code>optim_args</code> is a named list of additional arguments for <code>optim</code>.</li>
<li>
<code>auto</code> is a logical value indicating whether the events should be automatically reconfigured if the optimization converges.</li>
<li>
<code>...</code> gives additional arguments for <code>objective</code>.</li>
</ul>
</div>
<div id="running-the-simulator" class="section level2">
<h2 class="hasAnchor">
<a href="#running-the-simulator" class="anchor"></a>Running the simulator</h2>
<p>Simulation sequences of varying lengths can be carried out with the <code>Simulator</code> class method <code>run</code>.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">Simulator</span>$<span class="fu">run</span>(<span class="no">t_sim</span>)</pre></body></html></div>
<p>Here, <code>t_sim</code> is a numeric value indicating the length of the simulation in the internal simulation units (e.g., days). The current status of the population can be accessed at any time via the method <code>get_population</code>.</p>
</div>
<div id="parallel-computation" class="section level2">
<h2 class="hasAnchor">
<a href="#parallel-computation" class="anchor"></a>Parallel computation</h2>
<p>The simulator can be configured to take advantage of multiple computing cores via the class method <code>start_cluster</code>.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">Simulator</span>$<span class="fu">start_cluster</span>(<span class="no">cl</span>, <span class="no">nc</span>, <span class="no">export</span>, <span class="no">interface</span>)</pre></body></html></div>
<p>The arguments are:</p>
<ul>
<li>
<code>cl</code> is a cluster object.</li>
<li>
<code>nc</code> denotes the number of workers to use.</li>
<li>
<code>export</code> is a character vector of object names in the global environment that should be made available to the workers, such as user-defined functions or additional data.</li>
<li>
<code>interface</code> gives the <code>foreach</code> backend to use, can be either <code>doParallel</code> or <code>doMPI</code>.</li>
</ul>
<p>The population is split into chunks of equal size (if possible) and distributed to the available workers along with other necessary data. The implementation takes advantage of the <code>foreach</code> package for this purpose and any interface to this looping construct can be used fundamentally, but only <code>doParallel</code> and <code>doMPI</code> are currently supported. The following example demonstrates the process of setting up the computation cluster in the case of <code>doParallel</code>:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">nc</span> <span class="kw">&lt;-</span> <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>()
<span class="no">cl</span> <span class="kw">&lt;-</span> <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span>(<span class="no">nc</span>)
<span class="kw pkg">doParallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span>(<span class="no">cl</span>)

<span class="no">sim</span>$<span class="fu">start_cluster</span>(<span class="no">cl</span>, <span class="no">nc</span>, <span class="kw">interface</span> <span class="kw">=</span> <span class="st">"doParallel"</span>)
<span class="co"># Carry out calibration / simulations</span>
<span class="no">sim</span>$<span class="fu">stop_cluster</span>()</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Santtu Tikka, Jussi Hakanen, Mirka Saarela, Juha Karvanen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
