<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example with diabetes and stroke • Sima</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Example with diabetes and stroke">
<meta property="og:description" content="An example use case of the simulation framework for modeling the incidence of diabetes and stroke, and mortality.
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Sima</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/Sima.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example.html">Example with diabetes and stroke</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/santikk/Sima/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Example with diabetes and stroke</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/santikk/Sima/blob/master/vignettes/example.Rmd"><code>vignettes/example.Rmd</code></a></small>
      <div class="hidden name"><code>example.Rmd</code></div>

    </div>

    
    
<p>In this example we consider a simulator for the incidence of type-2 diabetes and stroke with various risk factors as well as mortality from stroke and other causes.</p>
<div id="data-files" class="section level2">
<h2 class="hasAnchor">
<a href="#data-files" class="anchor"></a>Data files</h2>
<p>To run the example, the following data files are needed</p>
<ul>
<li>The Finnish WHO MONICA data: <a href="http://www.thl.fi/publications/monica/monograph_cd/data/form04_3.zip" class="uri">http://www.thl.fi/publications/monica/monograph_cd/data/form04_3.zip</a>
</li>
<li>Finnish mortality statistics from Statistics Finland for the year 2017. The material was downloaded from Statistics Finland’s interface service on 10 May 2020 with the license <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY 4.0</a>: <a href="http://users.jyu.fi/~santikka/Sima/data/kuol_007_201700.csv" class="uri">http://users.jyu.fi/~santikka/Sima/data/kuol_007_201700.csv</a>
</li>
<li>Finnish age structure statistics from Statistics Finland for the year 2017. The material was downloaded from Statistics Finland’s interface service on 11 May 2020 with the license <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY 4.0</a>: <a href="http://users.jyu.fi/~santikka/Sima/data/vaesto_3112_2017.csv" class="uri">http://users.jyu.fi/~santikka/Sima/data/vaesto_3112_2017.csv</a>
</li>
</ul>
<p>The data files (with MONICA data unzipped) should be placed to directory called <code>data</code> in relation to the working directory for the purposes of this example.</p>
</div>
<div id="r-scripts" class="section level2">
<h2 class="hasAnchor">
<a href="#r-scripts" class="anchor"></a>R scripts</h2>
<p>The R script files required to run the example can be downloaded at <a href="http://users.jyu.fi/~santikka/Sima/DiabetesAndStroke.zip" class="uri">http://users.jyu.fi/~santikka/Sima/DiabetesAndStroke.zip</a></p>
<p>The zip file contains the following</p>
<ul>
<li>
<code>DiabetesAndStroke.R</code> is the primary script that contains the all the simulator definition and simulation runs.</li>
<li>
<code>DiabetesAndStrokeEvents.R</code> contains all the event definitions.</li>
<li>
<code>DiabetesAndStrokeData.R</code> contains the function to generate the initial population.</li>
<li>
<code>DiabetesAndStrokeFunctions.R</code> contains utility function definitions that are used throughout.</li>
</ul>
<p>The contents of these scripts are also listed in the following sections for direct viewing</p>
</div>
<div id="main-script" class="section level2">
<h2 class="hasAnchor">
<a href="#main-script" class="anchor"></a>Main script</h2>
<p>The file <code>DiabetesAndStroke.R</code> provides the code to run the entire example</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co"># An example use case of the simulator for </span>
<span class="co"># modelling the occurrence of diabetes and stroke</span>
<span class="co"># in a synthetic population with Finnish population</span>
<span class="co"># characteristics in the year 2017.</span>

<span class="co"># Uncomment to install packages</span>
<span class="co"># install.packages(c("data.table", "ggplot2", "bestNormalize", "devtools"))</span>
<span class="co"># devtools::install_github("santikk/Sima")</span>

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">Sima</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">data.table</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)


<span class="co"># The file_path should be set to the location of the R-scripts, such that</span>
<span class="co"># the data-directory is present in this location</span>

<span class="no">file_path</span> <span class="kw">&lt;-</span> <span class="st">""</span>
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="no">file_path</span>)

<span class="co"># Verify that all data files are available</span>
<span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="st">"data/vaesto_3112_2017.csv"</span>)) {
    <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Data file vaesto_3112_2017.csv not found in data directory."</span>)
}

<span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="st">"data/kuol_007_201700.csv"</span>)) {
    <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Data file kuol_007_201700 not found in data directory."</span>)
}

<span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="st">"data/form04_3.txt"</span>)) {
    <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(<span class="st">"Data file form04_3.txt not found in data directory."</span>)
}

<span class="co">#####################</span>
<span class="co"># Utility Functions #</span>
<span class="co">#####################</span>

<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"DiabetesAndStrokeFunctions.R"</span>)

<span class="co">##########</span>
<span class="co"># Events #</span>
<span class="co">##########</span>

<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"DiabetesAndStrokeEvents.R"</span>)

<span class="co">######################</span>
<span class="co"># Initial Population #</span>
<span class="co">######################</span>

<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"DiabetesAndStrokeData.R"</span>)

<span class="co">##################</span>
<span class="co"># Initialization #</span>
<span class="co">##################</span>

<span class="no">sim</span> <span class="kw">&lt;-</span> <span class="no">Simulator</span>$<span class="fu">new</span>(
    <span class="kw">initializer</span> <span class="kw">=</span> <span class="no">initializer</span>,
    <span class="kw">manipulation_events</span> <span class="kw">=</span> <span class="no">all_events</span>,
    <span class="kw">time</span> <span class="kw">=</span> <span class="no">Time</span>$<span class="fu">new</span>(<span class="kw">unit</span> <span class="kw">=</span> <span class="st">"day"</span>, <span class="kw">start</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()),
    <span class="kw">seeds</span> <span class="kw">=</span> <span class="fl">242</span>,
    <span class="kw">n</span> <span class="kw">=</span> <span class="fl">1e6</span>
)

<span class="co">###############</span>
<span class="co"># Calibration #</span>
<span class="co">###############</span>

<span class="co">## Uncomment to enable a parallel cluster for remaining computations</span>
<span class="co"># if (require(doParallel)) {</span>
<span class="co">#    nc &lt;- parallel::detectCores()</span>
<span class="co">#    cl &lt;- parallel::makeCluster(nc)</span>
<span class="co">#    doParallel::registerDoParallel(cl)</span>
<span class="co">#    ## User made functions/objects have to be manually exported, list them in 'export'</span>
<span class="co">#    sim$start_cluster(cl, nc, export = c("logit", "expit", "rbern"))</span>
<span class="co"># }</span>

<span class="co"># Uncomment to perform calibration</span>
<span class="co">#calib_result &lt;- optim(c(18, 140), mortality_objective, method = "Nelder-Mead")</span>

<span class="co"># Using a population of 1 million individuals, the following optimum is found:</span>
<span class="co"># c(13.51056, 161.12780, 5.41859)</span>

<span class="co"># Configure the simulator to use the optimal parameters (if calibration not run)</span>
<span class="co"># Here, only 1st parameter is configured for stroke mortality</span>
<span class="no">sim</span>$<span class="fu">reconfigure</span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"Other Mortality"</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">13.51056</span>, <span class="fl">161.12780</span>), <span class="st">"Stroke Mortality"</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">5.41859</span>, <span class="fl">1</span>)))

<span class="co"># Visualize and compare simulated mortality to official statistics</span>
<span class="no">sim</span>$<span class="fu">run</span>(<span class="fl">364</span>)
<span class="no">sim</span>$<span class="fu">stop_cluster</span>()

<span class="no">mortality</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="kw">file</span> <span class="kw">=</span> <span class="st">"data/kuol_007_201700.csv"</span>, <span class="kw">header</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">sep</span> <span class="kw">=</span> <span class="st">","</span>)
<span class="no">mortality</span>[,<span class="fl">3</span>] <span class="kw">&lt;-</span> <span class="no">mortality</span>[,<span class="fl">3</span>]/<span class="fl">1000</span>
<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">mortality</span>)
<span class="no">mortality</span> <span class="kw">&lt;-</span> <span class="no">mortality</span>[<span class="no">mortality</span>$<span class="no">Age</span> <span class="kw">&gt;=</span> <span class="fl">30</span>,]
<span class="no">calib_result</span> <span class="kw">&lt;-</span> <span class="fu">mortality_df</span>(<span class="no">sim</span>$<span class="fu">get_population</span>(), <span class="kw">min_age</span> <span class="kw">=</span> <span class="fl">30</span>)
<span class="no">sim_mortality</span> <span class="kw">&lt;-</span> <span class="no">calib_result</span>$<span class="no">out</span>

<span class="co"># Proportion of fatal stroke deaths of all deaths</span>
<span class="no">sim_stroke</span> <span class="kw">&lt;-</span> <span class="no">calib_result</span>$<span class="no">stroke_prop</span>

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">age</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">sim_mortality</span>$<span class="no">age_group</span>, <span class="fl">2</span>),
                 <span class="kw">mortality</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">sim_mortality</span>$<span class="no">deaths</span>/<span class="no">sim_mortality</span>$<span class="no">size</span>, <span class="no">mortality</span>[,<span class="fl">3</span>]),
                 <span class="kw">group</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/gl.html">gl</a></span>(<span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">mortality</span>), <span class="kw">labels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Simulated"</span>, <span class="st">"Reported"</span>)))

<span class="co"># Plot comparing mortality in the synthetic population to the official statistics</span>
<span class="no">g</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">age</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">mortality</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="no">group</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">lwd</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">16</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
        <span class="kw">legend.position</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.190</span>, <span class="fl">0.85</span>),
        <span class="kw">legend.key.width</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="fl">1.75</span>, <span class="st">"cm"</span>),
        <span class="kw">legend.key.size</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="fl">1.5</span>, <span class="st">"line"</span>),
        <span class="kw">legend.text</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">14</span>),
        <span class="kw">plot.margin</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5.5</span>, <span class="fl">12</span>, <span class="fl">5.5</span>, <span class="fl">5.5</span>), <span class="st">"points"</span>),
        <span class="kw">legend.background</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="st">"white"</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"solid"</span>)
    ) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">30</span>, <span class="fl">100</span>), <span class="kw">breaks</span> <span class="kw">=</span> <span class="fl">3</span>:<span class="fl">10</span> * <span class="fl">10</span>, <span class="kw">expand</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">0</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">0.4</span>), <span class="kw">expand</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_linetype_manual</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="kw">NULL</span>, <span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"longdash"</span>, <span class="st">"solid"</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Age"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Mortality"</span>, <span class="kw">title</span> <span class="kw">=</span> <span class="kw">NULL</span>)
<span class="no">g</span>

<span class="co">######################</span>
<span class="co"># Selective sampling #</span>
<span class="co">######################</span>

<span class="co"># Create a smaller sub population corresponding to the target sample </span>
<span class="co"># (increase population size to 3.6 million to include the </span>
<span class="co">#  entire population in the following comparisions [pop])</span>
<span class="no">sim_sample</span> <span class="kw">&lt;-</span> <span class="no">Simulator</span>$<span class="fu">new</span>(
    <span class="kw">initializer</span> <span class="kw">=</span> <span class="no">initializer</span>,
    <span class="kw">manipulation_events</span> <span class="kw">=</span> <span class="no">all_events</span>,
    <span class="kw">time</span> <span class="kw">=</span> <span class="no">Time</span>$<span class="fu">new</span>(<span class="kw">unit</span> <span class="kw">=</span> <span class="st">"day"</span>, <span class="kw">start</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()),
    <span class="kw">seeds</span> <span class="kw">=</span> <span class="fl">242</span>,
    <span class="kw">n</span> <span class="kw">=</span> <span class="fl">1e4</span>
)

<span class="co"># Configure the simulator to use the optimal parameters</span>
<span class="co"># Here, only 1st parameter is configured for stroke mortality</span>
<span class="no">sim_sample</span>$<span class="fu">reconfigure</span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"Other Mortality"</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">13.51056</span>, <span class="fl">161.12780</span>), <span class="st">"Stroke Mortality"</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">5.41859</span>, <span class="fl">1</span>)))

<span class="no">missingness</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">dt</span>) {
    <span class="no">beta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">9.484330</span>, -<span class="fl">0.311690</span>, <span class="fl">0.113614</span>, -<span class="fl">0.090696</span>, <span class="fl">0.036383</span>, <span class="fl">0.689770</span>)
    <span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span>(<span class="no">dt</span>[ ,<span class="fu">.</span>(<span class="kw">const</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="no">sex</span>, <span class="no">age</span>, <span class="no">bmi</span>, <span class="no">waist_circumference</span>, <span class="no">smoking</span>)])
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu">rbern</span>(<span class="fu">expit</span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">X</span> <span class="kw">%*%</span> <span class="no">beta</span>))))
}

<span class="no">pop</span> <span class="kw">&lt;-</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span>(<span class="no">sim_sample</span>$<span class="fu">get_population</span>())
<span class="no">m</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="fl">1e4</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">pop</span>))
<span class="no">baseline_sample</span> <span class="kw">&lt;-</span> <span class="no">pop</span>$<span class="no">id</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span>:<span class="no">m</span>, <span class="no">m</span>, <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">baseline_nonresp</span> <span class="kw">&lt;-</span> <span class="fu">missingness</span>(<span class="no">pop</span>[<span class="no">baseline_sample</span>,])
<span class="no">baseline_stroke</span> <span class="kw">&lt;-</span> <span class="no">pop</span>[<span class="no">baseline_sample</span>,<span class="no">stroke</span>]

<span class="co"># Uncomment to enable a parallel cluster for remaining computations</span>
<span class="co">#if (require(doParallel)) {</span>
<span class="co">#    nc &lt;- parallel::detectCores()</span>
<span class="co">#    cl &lt;- parallel::makeCluster(nc)</span>
<span class="co">#    doParallel::registerDoParallel(cl)</span>
<span class="co">#    ## User made functions/objects have to be manually exported, list them in 'export'</span>
<span class="co">#    sim_sample$start_cluster(cl, nc, export = c("expit", "logit", "rbern"))</span>
<span class="co">#}</span>

<span class="no">sim_sample</span>$<span class="fu">run</span>(<span class="fl">10</span> * <span class="fl">365</span>)
<span class="no">sim_sample</span>$<span class="fu">stop_cluster</span>()

<span class="co"># Update stroke status after 10 years</span>
<span class="no">pop_10y</span> <span class="kw">&lt;-</span> <span class="no">sim_sample</span>$<span class="fu">get_population</span>()[<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span>(<span class="no">id</span>),]
<span class="no">pop</span>[<span class="no">baseline_sample</span>, <span class="no">stroke</span> <span class="kw">:=</span> <span class="no">pop_10y</span>[<span class="no">baseline_sample</span>,<span class="no">stroke</span>]]

<span class="co"># Comparing two subsets: one with dropout (miss), one without (full)</span>
<span class="co"># (and one with the entire population, if included, otherwise same as full)</span>
<span class="no">included_miss</span> <span class="kw">&lt;-</span> <span class="no">baseline_sample</span> <span class="kw">&amp;</span> <span class="no">baseline_nonresp</span> <span class="kw">==</span> <span class="fl">0</span> <span class="kw">&amp;</span> <span class="no">baseline_stroke</span> <span class="kw">==</span> <span class="fl">0</span>
<span class="no">included_full</span> <span class="kw">&lt;-</span> <span class="no">baseline_sample</span> <span class="kw">&amp;</span> <span class="no">baseline_stroke</span> <span class="kw">==</span> <span class="fl">0</span>
<span class="co">#included_pop &lt;- baseline_stroke</span>

<span class="co"># Separate models for males and females</span>
<span class="no">model_miss_m</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="no">stroke</span> ~ <span class="no">age</span> + <span class="no">smoking</span> + <span class="no">blood_pressure</span> + <span class="no">hdl_cholesterol</span> + <span class="no">diabetes</span> + <span class="no">parent_stroke</span>,
                    <span class="kw">data</span> <span class="kw">=</span> <span class="no">pop</span>[<span class="no">included_miss</span> <span class="kw">&amp;</span> <span class="no">sex</span> <span class="kw">==</span> <span class="fl">0</span>, ], <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span>())
<span class="no">model_miss_f</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="no">stroke</span> ~ <span class="no">age</span> + <span class="no">smoking</span> + <span class="no">blood_pressure</span> + <span class="no">hdl_cholesterol</span> + <span class="no">diabetes</span> + <span class="no">parent_stroke</span>,
                    <span class="kw">data</span> <span class="kw">=</span> <span class="no">pop</span>[<span class="no">included_miss</span> <span class="kw">&amp;</span> <span class="no">sex</span> <span class="kw">==</span> <span class="fl">1</span>, ], <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span>())

<span class="no">model_full_m</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="no">stroke</span> ~ <span class="no">age</span> + <span class="no">smoking</span> + <span class="no">blood_pressure</span> + <span class="no">hdl_cholesterol</span> + <span class="no">diabetes</span> + <span class="no">parent_stroke</span>,
                    <span class="kw">data</span> <span class="kw">=</span> <span class="no">pop</span>[<span class="no">included_full</span> <span class="kw">&amp;</span> <span class="no">sex</span> <span class="kw">==</span> <span class="fl">0</span>, ], <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span>())
<span class="no">model_full_f</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="no">stroke</span> ~ <span class="no">age</span> + <span class="no">smoking</span> + <span class="no">blood_pressure</span> + <span class="no">hdl_cholesterol</span> + <span class="no">diabetes</span> + <span class="no">parent_stroke</span>,
                    <span class="kw">data</span> <span class="kw">=</span> <span class="no">pop</span>[<span class="no">included_full</span> <span class="kw">&amp;</span> <span class="no">sex</span> <span class="kw">==</span> <span class="fl">1</span>, ], <span class="kw">family</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span>())

<span class="co">#model_pop_m &lt;- glm(stroke ~ age + smoking + blood_pressure + hdl_cholesterol + diabetes + parent_stroke, </span>
<span class="co">#                    data = pop[included_pop &amp; sex == 0, ], family = binomial())</span>
<span class="co">#model_pop_f &lt;- glm(stroke ~ age + smoking + blood_pressure + hdl_cholesterol + diabetes + parent_stroke, </span>
<span class="co">#                    data = pop[included_pop &amp; sex == 1, ], family = binomial())</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">model_miss_m</span>)
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">model_miss_f</span>)
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">model_full_m</span>)
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">model_full_f</span>)
<span class="co">#summary(model_pop_f)</span>
<span class="co">#summary(model_pop_m)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">model_miss_m</span>)), <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">model_miss_f</span>)), <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">model_full_m</span>)), <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">model_full_f</span>)), <span class="fl">2</span>)
<span class="co">#round(exp(coef(model_pop_m)), 2)</span>
<span class="co">#round(exp(coef(model_pop_f)), 2)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span>(<span class="no">model_miss_m</span>)), <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span>(<span class="no">model_miss_f</span>)), <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span>(<span class="no">model_full_m</span>)), <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span>(<span class="no">model_full_f</span>)), <span class="fl">2</span>)
<span class="co">#round(exp(confint(model_pop_m)), 2)</span>
<span class="co">#round(exp(confint(model_pop_f)), 2)</span></pre></body></html></div>
</div>
<div id="events" class="section level2">
<h2 class="hasAnchor">
<a href="#events" class="anchor"></a>Events</h2>
<p>The file <code>DiabetesAndStrokeEvents.R</code> includes the event definitions</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co">#####################</span>
<span class="co"># Event definitions #</span>
<span class="co">#####################</span>

<span class="no">aging</span> <span class="kw">&lt;-</span> <span class="no">ManipulationEvent</span>$<span class="fu">new</span>(
    <span class="kw">name</span> <span class="kw">=</span> <span class="st">"Aging"</span>,
    <span class="kw">description</span> <span class="kw">=</span> <span class="st">"Normal aging of individuals"</span>,
    <span class="kw">parameters</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(),
    <span class="kw">mechanism</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>({
        <span class="no">status</span>[<span class="no">living</span>, <span class="no">age</span> <span class="kw">:=</span> <span class="no">age</span> + <span class="fl">1.0</span> / <span class="fl">365.0</span>]
    })
)

<span class="no">other_mortality</span> <span class="kw">&lt;-</span> <span class="no">ManipulationEvent</span>$<span class="fu">new</span>(
    <span class="kw">name</span> <span class="kw">=</span> <span class="st">"Other Mortality"</span>,
    <span class="kw">description</span> <span class="kw">=</span> <span class="st">"Risk of death when no stroke has occurred"</span>,
    <span class="kw">parameters</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">13.16346</span>, <span class="fl">165.34514</span>),
    <span class="kw">mechanism</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>({
        <span class="no">status</span>[<span class="no">living</span> <span class="kw">&amp;</span> <span class="no">stroke</span> <span class="kw">==</span> <span class="fl">0L</span>, <span class="no">alive</span> <span class="kw">:=</span> <span class="fu">rbern</span>(<span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html">pweibull</a></span>(<span class="no">age</span>, <span class="kw">shape</span> <span class="kw">=</span> <span class="no">par</span>[<span class="fl">1</span>], <span class="kw">scale</span> <span class="kw">=</span> <span class="no">par</span>[<span class="fl">2</span>]))]
    })
)

<span class="no">get_stroke</span> <span class="kw">&lt;-</span> <span class="no">ManipulationEvent</span>$<span class="fu">new</span>(
    <span class="kw">name</span> <span class="kw">=</span> <span class="st">"Stroke"</span>,
    <span class="kw">description</span> <span class="kw">=</span> <span class="st">"Risk of suffering a stroke"</span>,
    <span class="kw">parameters</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
        <span class="co"># const  age    smoking  bp        hdl     diab.   parents' stroke</span>
        -<span class="fl">11.699</span>, <span class="fl">0.1153</span>, <span class="fl">0.4981</span>, <span class="fl">0.0149</span>,  -<span class="fl">0.4406</span>, <span class="fl">0.879</span>,  <span class="fl">0.2933</span>, <span class="co"># stroke, male</span>
        -<span class="fl">7.966</span>,  <span class="fl">0.0633</span>, <span class="fl">0.4163</span>, <span class="fl">0.00893</span>, -<span class="fl">0.7636</span>, <span class="fl">1.2383</span>, <span class="fl">0.5470</span>  <span class="co"># stroke, female</span>
    ),
    <span class="kw">mechanism</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>({
        <span class="no">subset_male</span>   <span class="kw">&lt;-</span> <span class="no">status</span>[<span class="no">living</span> <span class="kw">&amp;</span> <span class="no">stroke</span> <span class="kw">==</span> <span class="fl">0L</span> <span class="kw">&amp;</span> <span class="no">sex</span> <span class="kw">==</span> <span class="fl">0L</span>, <span class="kw">which</span> <span class="kw">=</span> <span class="fl">TRUE</span>]
        <span class="no">subset_female</span> <span class="kw">&lt;-</span> <span class="no">status</span>[<span class="no">living</span> <span class="kw">&amp;</span> <span class="no">stroke</span> <span class="kw">==</span> <span class="fl">0L</span> <span class="kw">&amp;</span> <span class="no">sex</span> <span class="kw">==</span> <span class="fl">1L</span>, <span class="kw">which</span> <span class="kw">=</span> <span class="fl">TRUE</span>]
        <span class="no">X_male</span>   <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span>(<span class="no">status</span>[<span class="no">subset_male</span>,   <span class="fu">.</span>(<span class="kw">const</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="no">age</span>, <span class="no">smoking</span>, <span class="no">blood_pressure</span>, <span class="no">hdl_cholesterol</span>, <span class="no">diabetes</span>, <span class="no">parent_stroke</span>)])
        <span class="no">X_female</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span>(<span class="no">status</span>[<span class="no">subset_female</span>, <span class="fu">.</span>(<span class="kw">const</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="no">age</span>, <span class="no">smoking</span>, <span class="no">blood_pressure</span>, <span class="no">hdl_cholesterol</span>, <span class="no">diabetes</span>, <span class="no">parent_stroke</span>)])

        <span class="co"># Compute 1 day risk from 10 year risk by assuming a Poisson process.</span>
        <span class="no">prob_male_10year</span>   <span class="kw">&lt;-</span> <span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="fu">expit</span>( (<span class="no">X_male</span> <span class="kw">%*%</span> <span class="no">par</span>[<span class="fl">1</span>:<span class="fl">7</span>])[ ,<span class="fl">1</span>] ), <span class="fl">1</span>)
        <span class="no">prob_female_10year</span> <span class="kw">&lt;-</span> <span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="fu">expit</span>( (<span class="no">X_female</span> <span class="kw">%*%</span> <span class="no">par</span>[<span class="fl">8</span>:<span class="fl">14</span>])[ ,<span class="fl">1</span>] ), <span class="fl">1</span>)
        <span class="no">lambda_male</span>   <span class="kw">&lt;-</span> -<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">prob_male_10year</span>, <span class="fl">1e-12</span>)) / <span class="fl">3650</span>
        <span class="no">lambda_female</span> <span class="kw">&lt;-</span> -<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">prob_female_10year</span>, <span class="fl">1e-12</span>)) / <span class="fl">3650</span>
        <span class="no">new_stroke_male</span>   <span class="kw">&lt;-</span> <span class="fu">rbern</span>(<span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">lambda_male</span>))
        <span class="no">new_stroke_female</span> <span class="kw">&lt;-</span> <span class="fu">rbern</span>(<span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">lambda_female</span>))

        <span class="co"># Assign dates for stroke occurrence, update stroke status</span>
        <span class="no">status</span>[<span class="no">subset_male</span>,   <span class="fu">`:=`</span> (<span class="kw">age_at_stroke</span> <span class="kw">=</span> <span class="no">age</span> * <span class="no">new_stroke_male</span>,   <span class="kw">stroke</span> <span class="kw">=</span> <span class="no">new_stroke_male</span>)]
        <span class="no">status</span>[<span class="no">subset_female</span>, <span class="fu">`:=`</span> (<span class="kw">age_at_stroke</span> <span class="kw">=</span> <span class="no">age</span> * <span class="no">new_stroke_female</span>, <span class="kw">stroke</span> <span class="kw">=</span> <span class="no">new_stroke_female</span>)]
    })
)

<span class="no">get_diabetes</span> <span class="kw">&lt;-</span> <span class="no">ManipulationEvent</span>$<span class="fu">new</span>(
    <span class="kw">name</span> <span class="kw">=</span> <span class="st">"Diabetes"</span>,
    <span class="kw">description</span> <span class="kw">=</span> <span class="st">"Risk of getting diabetes"</span>,
    <span class="kw">parameters</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
        <span class="co"># const  age(45-54) age(55-64) bmi(25-30) bmi(&gt;30) w. circ. (1) w.circ. (2) bp med. h. glucose</span>
        -<span class="fl">5.514</span>,  <span class="fl">0.628</span>,     <span class="fl">0.892</span>,     <span class="fl">0.165</span>,     <span class="fl">1.096</span>,   <span class="fl">0.857</span>,       <span class="fl">1.350</span>,      <span class="fl">0.711</span>,  <span class="fl">2.139</span>
    ),
    <span class="kw">mechanism</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>({
        <span class="no">subset</span> <span class="kw">&lt;-</span> <span class="no">status</span>[<span class="no">living</span> <span class="kw">&amp;</span> <span class="no">diabetes</span> <span class="kw">==</span> <span class="fl">0L</span> <span class="kw">&amp;</span> <span class="no">age</span> <span class="kw">&gt;=</span> <span class="fl">45</span>, <span class="kw">which</span> <span class="kw">=</span> <span class="fl">TRUE</span>]
        <span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span>(<span class="no">status</span>[<span class="no">subset</span>, <span class="fu">.</span>(
            <span class="kw">const</span> <span class="kw">=</span> <span class="fl">1</span>,
            <span class="kw">age1</span> <span class="kw">=</span> (<span class="no">age</span> <span class="kw">&gt;=</span> <span class="fl">45</span> <span class="kw">&amp;</span> <span class="no">age</span> <span class="kw">&lt;</span> <span class="fl">54</span>),
            <span class="kw">age2</span> <span class="kw">=</span> (<span class="no">age</span> <span class="kw">&gt;=</span> <span class="fl">54</span>),
            <span class="kw">bmi1</span> <span class="kw">=</span> (<span class="no">bmi</span> <span class="kw">&gt;</span> <span class="fl">25</span> <span class="kw">&amp;</span> <span class="no">bmi</span> <span class="kw">&lt;=</span> <span class="fl">30</span>),
            <span class="kw">bmi2</span> <span class="kw">=</span> (<span class="no">bmi</span> <span class="kw">&gt;</span> <span class="fl">30</span>),
            <span class="kw">waist_circumference1</span> <span class="kw">=</span> (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">0L</span>) * (<span class="no">waist_circumference</span> <span class="kw">&gt;=</span> <span class="fl">94</span> <span class="kw">&amp;</span> <span class="no">waist_circumference</span> <span class="kw">&lt;</span> <span class="fl">102</span>) +
                                   (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">1L</span>) * (<span class="no">waist_circumference</span> <span class="kw">&gt;=</span> <span class="fl">80</span> <span class="kw">&amp;</span> <span class="no">waist_circumference</span> <span class="kw">&lt;</span> <span class="fl">88</span>),
            <span class="kw">waist_circumference2</span> <span class="kw">=</span> (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">0L</span>) * (<span class="no">waist_circumference</span> <span class="kw">&gt;=</span> <span class="fl">102</span>) +
                                   (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">1L</span>) * (<span class="no">waist_circumference</span> <span class="kw">&gt;=</span> <span class="fl">88</span>),
            <span class="no">takes_bp_medicine</span>,
            <span class="no">high_glucose</span>)
        ])

        <span class="co"># Compute 1 day risk from 10 year risk by assuming a Poisson process.</span>
        <span class="no">prob_10year</span> <span class="kw">&lt;-</span> <span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="fu">expit</span>((<span class="no">X</span> <span class="kw">%*%</span> <span class="no">par</span>)[ ,<span class="fl">1</span>]), <span class="fl">1</span>)
        <span class="no">lambda</span> <span class="kw">&lt;-</span> -<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">prob_10year</span>, <span class="fl">1e-12</span>)) / <span class="fl">3650</span>
        <span class="no">new_diabetes</span> <span class="kw">&lt;-</span> <span class="fu">rbern</span>(<span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">lambda</span>))

        <span class="co"># Update diabetes status</span>
        <span class="no">status</span>[<span class="no">subset</span>, <span class="fu">`:=`</span> (<span class="kw">diabetes</span> <span class="kw">=</span> <span class="no">new_diabetes</span>)]
    })
)

<span class="no">stroke_mortality</span> <span class="kw">&lt;-</span> <span class="no">ManipulationEvent</span>$<span class="fu">new</span>(
    <span class="kw">name</span> <span class="kw">=</span> <span class="st">"Stroke Mortality"</span>,
    <span class="kw">description</span> <span class="kw">=</span> <span class="st">"Risk of death after suffering a stroke"</span>,
    <span class="kw">parameters</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5.41859</span>, <span class="fl">8.17473693</span>, -<span class="fl">2.47553590</span>, -<span class="fl">0.01651868</span>),
    <span class="kw">mechanism</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>({
        <span class="no">status</span>[<span class="no">living</span> <span class="kw">&amp;</span> <span class="no">stroke</span> <span class="kw">==</span> <span class="fl">1L</span>, <span class="no">alive</span> <span class="kw">:=</span> <span class="fu">rbern</span>(<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span>(<span class="no">age</span> - <span class="no">age_at_stroke</span> <span class="kw">&lt;</span> (<span class="fl">28.0</span> / <span class="fl">365.0</span>), <span class="no">par</span>[<span class="fl">1</span>], <span class="fu">expit</span>(<span class="no">par</span>[<span class="fl">2</span>] + <span class="no">par</span>[<span class="fl">3</span>] * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(((<span class="no">age</span> - <span class="no">age_at_stroke</span>) * <span class="fl">365</span> - <span class="fl">27</span>) * <span class="no">par</span>[<span class="fl">4</span>]))))]
    })
)

<span class="no">bp_medication</span> <span class="kw">&lt;-</span> <span class="no">ManipulationEvent</span>$<span class="fu">new</span>(
    <span class="kw">name</span> <span class="kw">=</span> <span class="st">"Medicine"</span>,
    <span class="kw">description</span> <span class="kw">=</span> <span class="st">"Blood pressure medication"</span>,
    <span class="kw">parameters</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">140</span>),
    <span class="kw">mechanism</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>({
        <span class="no">status</span>[<span class="no">living</span> <span class="kw">&amp;</span> <span class="no">blood_pressure</span> <span class="kw">&gt;=</span> <span class="no">par</span>[<span class="fl">1</span>] <span class="kw">&amp;</span> <span class="no">takes_bp_medicine</span> <span class="kw">==</span> <span class="fl">0L</span>, <span class="fu">`:=`</span> (<span class="kw">takes_bp_medicine</span> <span class="kw">=</span> <span class="fl">1L</span>, <span class="kw">blood_pressure</span> <span class="kw">=</span> <span class="no">blood_pressure</span> - <span class="fl">5</span>)]
    })
)

<span class="co"># Further event organizing</span>
<span class="no">stroke_events</span>  <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">stroke_mortality</span>, <span class="no">get_stroke</span>)
<span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="no">stroke_events</span>, <span class="st">"ordered"</span>) <span class="kw">&lt;-</span> <span class="fl">TRUE</span>
<span class="no">other_events</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">stroke_events</span>, <span class="no">other_mortality</span>, <span class="no">bp_medication</span>, <span class="no">get_diabetes</span>)
<span class="no">all_events</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">aging</span>, <span class="no">other_events</span>)
<span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="no">all_events</span>, <span class="st">"ordered"</span>) <span class="kw">&lt;-</span> <span class="fl">TRUE</span></pre></body></html></div>
</div>
<div id="initial-population" class="section level2">
<h2 class="hasAnchor">
<a href="#initial-population" class="anchor"></a>Initial population</h2>
<p>The file <code>DiabetesAndStrokeData.R</code> contains the following function for generating the initial population (of size <code>n</code>)</p>
<div class="sourceCode"><html><body><pre class="r"><span class="no">initializer</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">n</span>) {
    <span class="co"># Seed for initial data generation</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">100</span>)
    <span class="kw pkg">dqrng</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/dqrng/man/dqrng-functions.html">dqset.seed</a></span>(<span class="fl">100</span>)
    <span class="no">widths</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">6</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">8</span>,<span class="fl">8</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span>,
                <span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">8</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">8</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">4</span>,<span class="fl">4</span>)
    <span class="no">colnames</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"form"</span>,<span class="st">"versn"</span>,<span class="st">"centre"</span>,<span class="st">"runit"</span>,<span class="st">"serial"</span>,<span class="st">"numsur"</span>,<span class="st">"samunit"</span>,<span class="st">"dexam"</span>,<span class="st">"mbirth"</span>,
                  <span class="st">"agegr"</span>,<span class="st">"sex"</span>,<span class="st">"marit"</span>,<span class="st">"edlevel"</span>,<span class="st">"school"</span>,<span class="st">"cigs"</span>,<span class="st">"numcigs"</span>,<span class="st">"daycigs"</span>,<span class="st">"evercig"</span>,
                  <span class="st">"stop"</span>,<span class="st">"iflyear"</span>,<span class="st">"maxcigs"</span>,<span class="st">"cigage"</span>,<span class="st">"cigarsm"</span>,<span class="st">"cigar"</span>,<span class="st">"pipesm"</span>,<span class="st">"pipe"</span>,<span class="st">"othersm"</span>,
                  <span class="st">"hibp"</span>,<span class="st">"drugs"</span>,<span class="st">"bprecd"</span>,<span class="st">"hich"</span>,<span class="st">"chdt"</span>,<span class="st">"chrx"</span>,<span class="st">"chrecd"</span>,<span class="st">"asp"</span>,<span class="st">"menop"</span>,<span class="st">"agem"</span>,
                  <span class="st">"horm"</span>,<span class="st">"pill"</span>,<span class="st">"syst1"</span>,<span class="st">"diast1"</span>,<span class="st">"rz1"</span>,<span class="st">"syst2"</span>,<span class="st">"diast2"</span>,<span class="st">"rz2"</span>,<span class="st">"cuff"</span>,<span class="st">"arm"</span>,
                  <span class="st">"bpcoder"</span>,<span class="st">"timebp"</span>,<span class="st">"rtemp"</span>,<span class="st">"chol"</span>,<span class="st">"choldl"</span>,<span class="st">"dchol"</span>,<span class="st">"hdl"</span>,<span class="st">"hdldl"</span>,<span class="st">"dhdl"</span>,<span class="st">"scn"</span>,
                  <span class="st">"cotin"</span>,<span class="st">"carbmon"</span>,<span class="st">"height"</span>,<span class="st">"weight"</span>,<span class="st">"waist"</span>,<span class="st">"hip"</span>,<span class="st">"whcoder"</span>,<span class="st">"oversion"</span>,<span class="st">"eage"</span>,
                  <span class="st">"eageg"</span>,<span class="st">"cohort1"</span>,<span class="st">"cohort2"</span>,<span class="st">"edtert1"</span>,<span class="st">"edtert2"</span>,<span class="st">"systm"</span>,<span class="st">"diastm"</span>,<span class="st">"chola"</span>,<span class="st">"hdla"</span>)
    <span class="no">monica</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.fwf.html">read.fwf</a></span>(<span class="st">"data/form04_3.txt"</span>, <span class="kw">widths</span> <span class="kw">=</span> <span class="no">widths</span>, <span class="kw">col.names</span> <span class="kw">=</span> <span class="no">colnames</span>)

    <span class="no">age_structure</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv2</a></span>(<span class="kw">file</span> <span class="kw">=</span> <span class="st">"data/vaesto_3112_2017.csv"</span>, <span class="kw">header</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
    <span class="no">sex</span> <span class="kw">&lt;-</span> <span class="fu">rbin</span>(<span class="no">n</span>)
    <span class="no">mf</span> <span class="kw">&lt;-</span> <span class="no">age_structure</span>[,<span class="fl">2</span>:<span class="fl">3</span>]
    <span class="no">age_structure</span>[,<span class="fl">2</span>:<span class="fl">3</span>] <span class="kw">&lt;-</span> <span class="no">mf</span> / <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(<span class="no">mf</span>)[<span class="fu"><a href="https://rdrr.io/r/base/col.html">col</a></span>(<span class="no">mf</span>)]
    <span class="no">age</span> <span class="kw">&lt;-</span> (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">0L</span>) * <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">30</span>:<span class="fl">99</span>, <span class="no">n</span>, <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="no">age_structure</span>[,<span class="fl">2</span>]) +
           (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">1L</span>) * <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">30</span>:<span class="fl">99</span>, <span class="no">n</span>, <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="no">age_structure</span>[,<span class="fl">3</span>])
    <span class="no">smoking</span> <span class="kw">&lt;-</span> <span class="fu">sex_age_init</span>(<span class="no">n</span>, <span class="no">sex</span>, <span class="no">age</span>,
                            <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.319</span>, <span class="fl">0.298</span>, <span class="fl">0.278</span>, <span class="fl">0.219</span>, <span class="fl">0.109</span>, <span class="fl">0.016</span>),
                            <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.229</span>, <span class="fl">0.193</span>, <span class="fl">0.184</span>, <span class="fl">0.147</span>, <span class="fl">0.054</span>, <span class="fl">0.016</span>), <span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span>)

    <span class="no">parent_stroke</span> <span class="kw">&lt;-</span> <span class="fu">rbin</span>(<span class="no">n</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.127</span>)
    <span class="no">high_glucose</span> <span class="kw">&lt;-</span> <span class="fu">sex_age_init</span>(<span class="no">n</span>, <span class="no">sex</span>, <span class="no">age</span>,
                                 <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.013</span>, <span class="fl">0.043</span>, <span class="fl">0.080</span>, <span class="fl">0.114</span>, <span class="fl">0.128</span>, <span class="fl">0.110</span>),
                                 <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.019</span>, <span class="fl">0.012</span>, <span class="fl">0.030</span>, <span class="fl">0.055</span>, <span class="fl">0.121</span>, <span class="fl">0.093</span>), <span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">10</span>)
    <span class="no">stroke</span> <span class="kw">&lt;-</span> <span class="fu">sex_age_init</span>(<span class="no">n</span>, <span class="no">sex</span>, <span class="no">age</span>,
                           <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.027</span>, <span class="fl">0.063</span>, <span class="fl">0.091</span>, <span class="fl">0.163</span>),
                           <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.013</span>, <span class="fl">0.029</span>, <span class="fl">0.061</span>, <span class="fl">0.137</span>), <span class="fl">50</span>, <span class="fl">80</span>, <span class="fl">10</span>)
    <span class="no">age_at_stroke</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0.0</span>, <span class="no">n</span>)
    <span class="no">age_at_stroke</span>[<span class="no">stroke</span> <span class="kw">==</span> <span class="fl">1L</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">age</span>[<span class="no">stroke</span> <span class="kw">==</span> <span class="fl">1L</span>] -
        (<span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html">rweibull</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">stroke</span>), <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">0.509246</span>, <span class="kw">scale</span> <span class="kw">=</span> <span class="fl">1634.480968</span>)) / <span class="fl">365.0</span>, <span class="fl">30</span>)

    <span class="co"># decoding missing values</span>
    <span class="no">monica</span>$<span class="no">height</span>[<span class="no">monica</span>$<span class="no">height</span> <span class="kw">==</span> <span class="fl">999</span>] <span class="kw">&lt;-</span> <span class="fl">NA</span>
    <span class="no">monica</span>$<span class="no">weight</span>[<span class="no">monica</span>$<span class="no">weight</span> <span class="kw">==</span> <span class="fl">9999</span>] <span class="kw">&lt;-</span> <span class="fl">NA</span>
    <span class="no">monica</span>$<span class="no">waist</span>[<span class="no">monica</span>$<span class="no">waist</span> <span class="kw">==</span> <span class="fl">9999</span>] <span class="kw">&lt;-</span> <span class="fl">NA</span>
    <span class="no">monica</span>$<span class="no">systm</span>[<span class="no">monica</span>$<span class="no">systm</span> <span class="kw">==</span> <span class="fl">9999</span>] <span class="kw">&lt;-</span> <span class="fl">NA</span>
    <span class="no">monica</span>$<span class="no">chol</span>[<span class="no">monica</span>$<span class="no">chol</span> <span class="kw">&gt;=</span> <span class="fl">888</span>] <span class="kw">&lt;-</span> <span class="fl">NA</span>
    <span class="no">monica</span>$<span class="no">hdl</span>[<span class="no">monica</span>$<span class="no">hdl</span> <span class="kw">&gt;=</span> <span class="fl">777</span>] <span class="kw">&lt;-</span> <span class="fl">NA</span>

    <span class="co"># unit transformations</span>
    <span class="no">monica</span>$<span class="no">weight</span> <span class="kw">&lt;-</span> <span class="no">monica</span>$<span class="no">weight</span> / <span class="fl">10</span> <span class="co"># transform to kg</span>
    <span class="no">monica</span>$<span class="no">waist</span> <span class="kw">&lt;-</span> <span class="no">monica</span>$<span class="no">waist</span> / <span class="fl">10</span> <span class="co"># transform to cm</span>
    <span class="no">monica</span>$<span class="no">systm</span> <span class="kw">&lt;-</span> <span class="no">monica</span>$<span class="no">systm</span> / <span class="fl">10</span> <span class="co"># transform to mmHg</span>
    <span class="no">monica</span>$<span class="no">chol</span> <span class="kw">&lt;-</span> <span class="no">monica</span>$<span class="no">chol</span> / <span class="fl">10</span> <span class="co"># transform to mmol/l</span>
    <span class="no">monica</span>$<span class="no">hdl</span> <span class="kw">&lt;-</span> <span class="no">monica</span>$<span class="no">hdl</span> / <span class="fl">100</span> <span class="co"># transform to mmol/l</span>
    <span class="no">monica</span>$<span class="no">bmi</span> <span class="kw">&lt;-</span> <span class="no">monica</span>$<span class="no">weight</span> / (<span class="no">monica</span>$<span class="no">height</span> / <span class="fl">100</span>)^<span class="fl">2</span>
    <span class="no">monica</span>$<span class="no">sex</span> <span class="kw">&lt;-</span> <span class="no">monica</span>$<span class="no">sex</span> - <span class="fl">1</span> <span class="co"># female = 1</span>
    <span class="co">#monica$smoking &lt;- 0 + (monica$cigs %in% c(1,3))</span>
    <span class="no">monica</span>$<span class="no">smoking</span> <span class="kw">&lt;-</span> <span class="fl">0</span> + (<span class="no">monica</span>$<span class="no">cigs</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">3</span>) <span class="kw">|</span>
                           <span class="no">monica</span>$<span class="no">cigarsm</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">3</span>) <span class="kw">|</span>
                           <span class="no">monica</span>$<span class="no">pipesm</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">3</span>))

    <span class="no">selcol</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"bmi"</span>, <span class="st">"waist"</span>, <span class="st">"chol"</span>, <span class="st">"hdl"</span>, <span class="st">"systm"</span>)
    <span class="no">m</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">selcol</span>)
    <span class="no">monica2</span> <span class="kw">&lt;-</span> <span class="no">monica</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"eage"</span>, <span class="st">"sex"</span>, <span class="st">"smoking"</span>, <span class="no">selcol</span>)]
    <span class="no">out</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span>(<span class="no">monica2</span>$<span class="no">waist</span>), <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span>(<span class="no">monica2</span>$<span class="no">chol</span>))
    <span class="no">monica2</span> <span class="kw">&lt;-</span> <span class="no">monica2</span>[-<span class="no">out</span>,]
    <span class="no">monica2</span>$<span class="no">agegr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(<span class="no">monica2</span>$<span class="no">eage</span>, <span class="kw">breaks</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">70</span>), <span class="kw">right</span> <span class="kw">=</span> <span class="fl">FALSE</span>)

    <span class="co"># Generate initial values in each subgroup of sex, smoking and age</span>
    <span class="no">norm_grp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span>(<span class="kw">sex</span> <span class="kw">=</span> <span class="fl">0</span>:<span class="fl">1</span>, <span class="kw">smoking</span> <span class="kw">=</span> <span class="fl">0</span>:<span class="fl">1</span>, <span class="kw">agegr</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">5</span>)
    <span class="no">k</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">norm_grp</span>)
    <span class="no">norm_dat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">length</span> <span class="kw">=</span> <span class="no">k</span>)
    <span class="no">norm_par</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">length</span> <span class="kw">=</span> <span class="no">k</span>)

    <span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">k</span>) {
        <span class="no">ind</span> <span class="kw">&lt;-</span> (<span class="no">monica2</span>$<span class="no">sex</span> <span class="kw">==</span> <span class="no">norm_grp</span>[<span class="no">i</span>,<span class="fl">1</span>] <span class="kw">&amp;</span>
                <span class="no">monica2</span>$<span class="no">smoking</span> <span class="kw">==</span> <span class="no">norm_grp</span>[<span class="no">i</span>,<span class="fl">2</span>] <span class="kw">&amp;</span>
                <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">monica2</span>$<span class="no">agegr</span>) <span class="kw">==</span> <span class="no">norm_grp</span>[<span class="no">i</span>,<span class="fl">3</span>])
        <span class="no">ind</span>[<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">ind</span>)] <span class="kw">&lt;-</span> <span class="fl">FALSE</span>
        <span class="no">norm_par</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">trans</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
        <span class="no">norm_dat</span><span class="kw">[[</span><span class="no">i</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">ind</span>), <span class="no">m</span>)
        <span class="kw">for</span> (<span class="no">j</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">m</span>) {
            <span class="no">bc</span> <span class="kw">&lt;-</span> <span class="kw pkg">bestNormalize</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/bestNormalize/man/boxcox.html">boxcox</a></span>(<span class="no">monica2</span>[<span class="no">ind</span>,<span class="no">selcol</span>[<span class="no">j</span>]])
            <span class="no">norm_par</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">trans</span><span class="kw">[[</span><span class="no">j</span>]] <span class="kw">&lt;-</span> <span class="no">bc</span>
            <span class="no">norm_dat</span><span class="kw">[[</span><span class="no">i</span>]][,<span class="no">j</span>] <span class="kw">&lt;-</span> <span class="no">bc</span>$<span class="no">x.t</span>
        }
        <span class="no">norm_par</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">mu</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(<span class="no">norm_dat</span><span class="kw">[[</span><span class="no">i</span>]], <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
        <span class="no">norm_par</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">Sigma</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span>(<span class="no">norm_dat</span><span class="kw">[[</span><span class="no">i</span>]], <span class="kw">use</span> <span class="kw">=</span> <span class="st">"complete.obs"</span>)
    }

    <span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="no">n</span>, <span class="no">m</span>)

    <span class="no">age_mon</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(<span class="no">age</span>, <span class="kw">breaks</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">100</span>), <span class="kw">right</span> <span class="kw">=</span> <span class="fl">FALSE</span>))
    <span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fl">5</span>:<span class="no">k</span>) {
        <span class="no">ind</span> <span class="kw">&lt;-</span> (<span class="no">sex</span> <span class="kw">==</span> <span class="no">norm_grp</span>[<span class="no">i</span>,<span class="fl">1</span>] <span class="kw">&amp;</span>
                <span class="no">smoking</span> <span class="kw">==</span> <span class="no">norm_grp</span>[<span class="no">i</span>,<span class="fl">2</span>] <span class="kw">&amp;</span>
                <span class="no">age_mon</span> <span class="kw">==</span> <span class="no">norm_grp</span>[<span class="no">i</span>,<span class="fl">3</span>])
        <span class="no">temp</span> <span class="kw">&lt;-</span> <span class="kw pkg">MASS</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">ind</span>), <span class="kw">mu</span> <span class="kw">=</span> <span class="no">norm_par</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">mu</span>, <span class="kw">Sigma</span> <span class="kw">=</span> <span class="no">norm_par</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">Sigma</span>)
        <span class="kw">for</span> (<span class="no">j</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">m</span>) {
            <span class="no">temp</span>[,<span class="no">j</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">norm_par</span><span class="kw">[[</span><span class="no">i</span>]]$<span class="no">trans</span><span class="kw">[[</span><span class="no">j</span>]], <span class="no">temp</span>[,<span class="no">j</span>], <span class="kw">inverse</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
        }
        <span class="no">X</span>[<span class="no">ind</span>,] <span class="kw">&lt;-</span> <span class="no">temp</span>
    }

    <span class="co"># Limits data to values that have been actually observed</span>
    <span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu">impose_limits</span>(<span class="no">X</span>, <span class="no">sex</span>, <span class="no">smoking</span>, <span class="no">age_mon</span>,
                       <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">16</span>, <span class="fl">72.5</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">50</span>, <span class="fl">152</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.5</span>, <span class="fl">11.5</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.37</span>, <span class="fl">3.62</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">78</span>, <span class="fl">252</span>)))

    <span class="no">bmi</span> <span class="kw">&lt;-</span> <span class="no">X</span>[,<span class="fl">1</span>]
    <span class="no">waist_circumference</span> <span class="kw">&lt;-</span> <span class="no">X</span>[,<span class="fl">2</span>]
    <span class="no">cholesterol</span> <span class="kw">&lt;-</span> <span class="no">X</span>[,<span class="fl">3</span>]
    <span class="no">hdl_cholesterol</span> <span class="kw">&lt;-</span> <span class="no">X</span>[,<span class="fl">4</span>]
    <span class="no">blood_pressure</span> <span class="kw">&lt;-</span> <span class="no">X</span>[,<span class="fl">5</span>]

    <span class="co"># Generating diabetes status based on FINDRISC risk score</span>
    <span class="no">diabetes_par</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">5.514</span>, <span class="fl">0.628</span>, <span class="fl">0.892</span>, <span class="fl">0.165</span>, <span class="fl">1.096</span>, <span class="fl">0.857</span>, <span class="fl">1.350</span>, <span class="fl">2.139</span>)
    <span class="no">D</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="no">n</span>, <span class="fl">8</span>)
    <span class="no">D</span>[,<span class="fl">1</span>] <span class="kw">&lt;-</span> <span class="fl">1</span>
    <span class="no">D</span>[,<span class="fl">2</span>] <span class="kw">&lt;-</span> (<span class="no">age</span> <span class="kw">&gt;=</span> <span class="fl">45</span> <span class="kw">&amp;</span> <span class="no">age</span> <span class="kw">&lt;</span> <span class="fl">54</span>)
    <span class="no">D</span>[,<span class="fl">3</span>] <span class="kw">&lt;-</span> (<span class="no">age</span> <span class="kw">&gt;=</span> <span class="fl">54</span>)
    <span class="no">D</span>[,<span class="fl">4</span>] <span class="kw">&lt;-</span> (<span class="no">bmi</span> <span class="kw">&gt;</span> <span class="fl">25</span> <span class="kw">&amp;</span> <span class="no">bmi</span> <span class="kw">&lt;=</span> <span class="fl">30</span>)
    <span class="no">D</span>[,<span class="fl">5</span>] <span class="kw">&lt;-</span> (<span class="no">bmi</span> <span class="kw">&gt;</span> <span class="fl">30</span>)
    <span class="no">D</span>[,<span class="fl">6</span>] <span class="kw">&lt;-</span> (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">0L</span>) * (<span class="no">waist_circumference</span> <span class="kw">&gt;=</span> <span class="fl">94</span> <span class="kw">&amp;</span> <span class="no">waist_circumference</span> <span class="kw">&lt;</span> <span class="fl">102</span>) +
             (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">1L</span>) * (<span class="no">waist_circumference</span> <span class="kw">&gt;=</span> <span class="fl">80</span> <span class="kw">&amp;</span> <span class="no">waist_circumference</span> <span class="kw">&lt;</span> <span class="fl">88</span>)
    <span class="no">D</span>[,<span class="fl">7</span>] <span class="kw">&lt;-</span> (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">0L</span>) * (<span class="no">waist_circumference</span> <span class="kw">&gt;=</span> <span class="fl">102</span>) +
             (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">1L</span>) * (<span class="no">waist_circumference</span> <span class="kw">&gt;=</span> <span class="fl">88</span>)
    <span class="no">D</span>[,<span class="fl">8</span>] <span class="kw">&lt;-</span> <span class="no">high_glucose</span>
    <span class="no">diabetes_risk</span> <span class="kw">&lt;-</span> <span class="fu">expit</span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">D</span> <span class="kw">%*%</span> <span class="no">diabetes_par</span>))
    <span class="no">diabetes_risk</span>[<span class="no">sex</span> <span class="kw">==</span> <span class="fl">0L</span>] <span class="kw">&lt;-</span> <span class="no">diabetes_risk</span>[<span class="no">sex</span> <span class="kw">==</span> <span class="fl">0L</span>] / <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">diabetes_risk</span>[<span class="no">sex</span> <span class="kw">==</span> <span class="fl">0L</span>]) * <span class="fl">0.15</span>
    <span class="no">diabetes_risk</span>[<span class="no">sex</span> <span class="kw">==</span> <span class="fl">1L</span>] <span class="kw">&lt;-</span> <span class="no">diabetes_risk</span>[<span class="no">sex</span> <span class="kw">==</span> <span class="fl">1L</span>] / <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">diabetes_risk</span>[<span class="no">sex</span> <span class="kw">==</span> <span class="fl">1L</span>]) * <span class="fl">0.10</span>
    <span class="no">diabetes</span> <span class="kw">&lt;-</span> <span class="fu">rbern</span>(<span class="no">diabetes_risk</span>)

    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span>(
        <span class="kw">alive</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1L</span>, <span class="no">n</span>),
        <span class="kw">age</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="no">age</span>),
        <span class="kw">age_at_start</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="no">age</span>),
        <span class="kw">age_at_stroke</span> <span class="kw">=</span> <span class="no">age_at_stroke</span>,
        <span class="kw">sex</span> <span class="kw">=</span> <span class="no">sex</span>,
        <span class="kw">smoking</span> <span class="kw">=</span> <span class="no">smoking</span>,
        <span class="kw">diabetes</span> <span class="kw">=</span> <span class="no">diabetes</span>,
        <span class="kw">parent_stroke</span> <span class="kw">=</span> <span class="no">parent_stroke</span>,
        <span class="kw">high_glucose</span> <span class="kw">=</span> <span class="no">high_glucose</span>,
        <span class="kw">stroke</span> <span class="kw">=</span> <span class="no">stroke</span>,
        <span class="kw">bmi</span> <span class="kw">=</span> <span class="no">bmi</span>,
        <span class="kw">waist_circumference</span> <span class="kw">=</span> <span class="no">waist_circumference</span>,
        <span class="kw">cholesterol</span> <span class="kw">=</span> <span class="no">cholesterol</span>,
        <span class="kw">hdl_cholesterol</span> <span class="kw">=</span> <span class="no">hdl_cholesterol</span>,
        <span class="kw">blood_pressure</span> <span class="kw">=</span> <span class="no">blood_pressure</span>,
        <span class="kw">takes_bp_medicine</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0L</span>, <span class="no">n</span>),
        <span class="kw">id</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="no">n</span>
    ))

}</pre></body></html></div>
</div>
<div id="utility-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#utility-functions" class="anchor"></a>Utility functions</h2>
<p>The file <code>DiabetesAndStrokeFunctions.R</code> provides a set of useful functions used in defining events and the initial data</p>
<div class="sourceCode"><html><body><pre class="r"><span class="co">## Bernoulli distribution with probability of success (1) 'prob' (vectorized over prob)</span>

<span class="no">rbern</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">prob</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span>(<span class="kw pkg">dqrng</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/dqrng/man/dqrng-functions.html">dqrunif</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">prob</span>)) <span class="kw">&lt;</span> <span class="no">prob</span>, <span class="fl">1L</span>, <span class="fl">0L</span>))
}

<span class="co">## Uniformly random date between 'start' and 'end' dates (inclusive)</span>

<span class="no">rdate</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">start</span>, <span class="no">end</span>, <span class="no">...</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="no">start</span>), <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="no">end</span>), <span class="kw">by</span> <span class="kw">=</span> <span class="st">"day"</span>), <span class="no">...</span>))
}

<span class="co">## Random binary, where the probability of 1 is 'prob'</span>

<span class="no">rbin</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">size</span>, <span class="no">prob</span> <span class="kw">=</span> <span class="fl">0.5</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0L</span>, <span class="fl">1L</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="no">size</span>, <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span> - <span class="no">prob</span>, <span class="no">prob</span>)))
}

<span class="co">## The logistic link function</span>

<span class="no">logit</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">x</span>) - <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">1</span> - <span class="no">x</span>)

<span class="co">## Inverse logistic link</span>

<span class="no">expit</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) (<span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">x</span>))^(-<span class="fl">1</span>)

<span class="co">## Function to generate binary starting values based on age-based proportions</span>
<span class="co">## n        : number of values to generate</span>
<span class="co">## sex      : vector of sex for each individual</span>
<span class="co">## age      : vector of ages (in years)</span>
<span class="co">## val_m    : proportions for males in each age group</span>
<span class="co">## val_f    : proportions for females in each age group</span>
<span class="co">## age_min  : youngest age group, no individual should have an age below this</span>
<span class="co">## age_max  : oldest distinct age group, ages above this are considered a single group</span>
<span class="co">## age_step : size of each age group</span>

<span class="no">sex_age_init</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">n</span>, <span class="no">sex</span>, <span class="no">age</span>, <span class="no">val_m</span>, <span class="no">val_f</span>, <span class="no">age_min</span>, <span class="no">age_max</span>, <span class="no">age_step</span>) {
    <span class="no">groups</span> <span class="kw">&lt;-</span> (<span class="no">age_max</span> - <span class="no">age_min</span>) <span class="kw">%/%</span> <span class="no">age_step</span> + <span class="fl">1</span>
    <span class="no">age_group</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>((<span class="no">age</span> - <span class="no">age_min</span>) <span class="kw">%/%</span> <span class="no">age_step</span> + <span class="fl">1</span>, <span class="no">groups</span>)
    <span class="no">age_group</span>[<span class="no">age_group</span> <span class="kw">&lt;</span> <span class="fl">1</span>] <span class="kw">&lt;-</span> <span class="fl">NA</span>
    <span class="no">p</span> <span class="kw">&lt;-</span> (<span class="no">age_group</span> <span class="kw">&gt;</span> <span class="fl">0</span>) * ((<span class="no">sex</span> <span class="kw">==</span> <span class="fl">0</span>) * <span class="no">val_m</span>[<span class="no">age_group</span>] + (<span class="no">sex</span> <span class="kw">==</span> <span class="fl">1</span>) * <span class="no">val_f</span>[<span class="no">age_group</span>])
    <span class="no">p</span>[<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">p</span>)] <span class="kw">&lt;-</span> <span class="fl">0</span>
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n</span>, <span class="fl">1</span>, <span class="no">p</span>))
}

<span class="co">## Function to resample values within an allowed range</span>
<span class="co">## X       : a matrix of values</span>
<span class="co">## sex     : a vector of sex indicators</span>
<span class="co">## smoking : a vector of smoking indicators</span>
<span class="co">## age     : a vector of age groups</span>
<span class="co">## limits  : a list of allowed ranges for column of 'X'</span>

<span class="no">impose_limits</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">X</span>, <span class="no">sex</span>, <span class="no">smoking</span>, <span class="no">age</span>, <span class="no">limits</span>) {
    <span class="no">age</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">age</span>)
    <span class="no">groups</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span>(<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span>(<span class="no">sex</span>), <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span>(<span class="no">smoking</span>), <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span>(<span class="no">age</span>))
    <span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">groups</span>)) {
        <span class="no">g</span> <span class="kw">&lt;-</span> <span class="no">sex</span> <span class="kw">==</span> <span class="no">groups</span>[<span class="no">i</span>,<span class="fl">1</span>] <span class="kw">&amp;</span> <span class="no">smoking</span> <span class="kw">==</span> <span class="no">groups</span>[<span class="no">i</span>,<span class="fl">2</span>] <span class="kw">&amp;</span> <span class="no">age</span> <span class="kw">==</span> <span class="no">groups</span>[<span class="no">i</span>,<span class="fl">3</span>]
        <span class="kw">for</span> (<span class="no">j</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>)) {
            <span class="no">out</span> <span class="kw">&lt;-</span> <span class="no">X</span>[<span class="no">g</span>,<span class="no">j</span>] <span class="kw">&lt;</span> <span class="no">limits</span><span class="kw">[[</span><span class="no">j</span>]][<span class="fl">1</span>] <span class="kw">|</span> <span class="no">X</span>[<span class="no">g</span>,<span class="no">j</span>] <span class="kw">&gt;</span> <span class="no">limits</span><span class="kw">[[</span><span class="no">j</span>]][<span class="fl">2</span>]
            <span class="no">bound</span> <span class="kw">&lt;-</span> !<span class="no">out</span>
            <span class="no">g_out</span> <span class="kw">&lt;-</span> <span class="no">g</span>
            <span class="no">g_out</span>[<span class="no">g</span>] <span class="kw">&lt;-</span> <span class="no">out</span>
            <span class="no">g_bound</span> <span class="kw">&lt;-</span> <span class="no">g</span>
            <span class="no">g_bound</span>[<span class="no">g</span>] <span class="kw">&lt;-</span> !<span class="no">out</span>
            <span class="no">X</span>[<span class="no">g_out</span>,<span class="no">j</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="no">X</span>[<span class="no">g_bound</span>,<span class="no">j</span>], <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">out</span>), <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
        }
    }
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">X</span>)
}

<span class="co">## Objective function to calibrate total mortality to mortality of the Finnish population</span>
<span class="co">## x : current vector of parameter values</span>

<span class="no">mortality_objective</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
    <span class="no">mortality</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="kw">file</span> <span class="kw">=</span> <span class="st">"data/kuol_007_201700.csv"</span>, <span class="kw">header</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">sep</span> <span class="kw">=</span> <span class="st">","</span>)
    <span class="no">mortality</span>[,<span class="fl">3</span>] <span class="kw">&lt;-</span> <span class="no">mortality</span>[,<span class="fl">3</span>]/<span class="fl">1000</span>
    <span class="no">n</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">mortality</span>)
    <span class="no">mortality</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbind</a></span>(<span class="no">mortality</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">100</span>, <span class="fl">2017</span>, <span class="fl">2</span> * <span class="no">mortality</span>[<span class="no">n</span>,<span class="fl">3</span>] - <span class="no">mortality</span>[<span class="no">n</span>-<span class="fl">1</span>,<span class="fl">3</span>])) <span class="co"># Impute 100-year-olds from 99</span>
    <span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"Other Mortality"</span> <span class="kw">=</span> <span class="no">x</span>[<span class="fl">1</span>:<span class="fl">2</span>], <span class="st">"Stroke Mortality"</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">x</span>[<span class="fl">3</span>], <span class="fl">1</span>))
    <span class="no">calib_res</span> <span class="kw">&lt;-</span> <span class="no">sim</span>$<span class="fu">configure</span>(<span class="kw">t_sim</span> <span class="kw">=</span> <span class="fl">364</span>, <span class="kw">p</span> <span class="kw">=</span> <span class="no">p</span>, <span class="kw">output</span> <span class="kw">=</span> <span class="no">mortality_df</span>, <span class="kw">min_age</span> <span class="kw">=</span> <span class="fl">30</span>)
    <span class="no">out</span> <span class="kw">&lt;-</span> <span class="no">calib_res</span>$<span class="no">out</span>
    <span class="no">stroke_prop</span> <span class="kw">&lt;-</span> <span class="no">calib_res</span>$<span class="no">stroke_prop</span>
    <span class="no">s_obj</span> <span class="kw">&lt;-</span> <span class="fl">1e7</span>
    <span class="kw">if</span> (<span class="no">stroke_prop</span> <span class="kw">&gt;</span> <span class="fl">0</span>) <span class="no">s_obj</span> <span class="kw">&lt;-</span> <span class="fl">2000</span> * (<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">stroke_prop</span>) - <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">0.07534936</span>))^<span class="fl">2</span>
    <span class="no">mortality</span> <span class="kw">&lt;-</span> <span class="no">mortality</span>[<span class="no">mortality</span>$<span class="no">Age</span> <span class="kw">%in%</span> <span class="no">out</span>$<span class="no">age_group</span>,]
    <span class="no">w</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">out</span>))
    <span class="no">w</span>[<span class="no">out</span>$<span class="no">age_group</span> <span class="kw">&gt;=</span> <span class="fl">80</span>] <span class="kw">&lt;-</span> <span class="fl">100</span> <span class="co"># Weight for mortalities &gt;= 60, fit should be better here</span>
    <span class="no">valid</span> <span class="kw">&lt;-</span> (<span class="no">out</span>[ ,<span class="fl">2</span>] <span class="kw">!=</span> <span class="fl">0</span> <span class="kw">&amp;</span> <span class="no">out</span>[ ,<span class="fl">1</span>] <span class="kw">!=</span> <span class="no">out</span>[,<span class="fl">2</span>] <span class="kw">&amp;</span> <span class="no">out</span>[ ,<span class="fl">1</span>] <span class="kw">!=</span> <span class="fl">0</span>)
    <span class="no">all_dead</span> <span class="kw">&lt;-</span> <span class="no">out</span>[ ,<span class="fl">1</span>] <span class="kw">==</span> <span class="no">out</span>[ ,<span class="fl">2</span>]
    <span class="no">all_alive</span> <span class="kw">&lt;-</span> <span class="no">out</span>[ ,<span class="fl">1</span>] <span class="kw">==</span> <span class="fl">0</span>
    <span class="no">obj</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">w</span>[<span class="no">valid</span>] * (<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">mortality</span>[<span class="no">valid</span>,<span class="fl">3</span>]) - <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">out</span>[<span class="no">valid</span>,<span class="fl">1</span>]/<span class="no">out</span>[<span class="no">valid</span>,<span class="fl">2</span>]))^<span class="fl">2</span>)
    <span class="no">obj</span> <span class="kw">&lt;-</span> <span class="no">obj</span> + <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">w</span>[<span class="no">all_dead</span>] * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">mortality</span>[<span class="no">all_dead</span>,<span class="fl">3</span>])^<span class="fl">2</span>)
    <span class="no">obj</span> <span class="kw">&lt;-</span> <span class="no">obj</span> + <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">w</span>[<span class="no">all_alive</span>] * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">mortality</span>[<span class="no">all_alive</span>,<span class="fl">3</span>])^<span class="fl">2</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">obj</span> + <span class="no">s_obj</span>)
}

<span class="co">## A function used to calibrate total mortality</span>
<span class="co">## dt        : the status data.table</span>
<span class="co">## min_age   : the youngest age group</span>

<span class="no">mortality_df</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">dt</span>, <span class="no">min_age</span> <span class="kw">=</span> <span class="fl">0</span>) {
    <span class="no">dt</span>[ ,<span class="no">age_group</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span>(<span class="no">age</span>)]
    <span class="no">deaths</span> <span class="kw">&lt;-</span> <span class="no">dt</span>[<span class="no">alive</span> <span class="kw">==</span> <span class="fl">0</span>, <span class="no">.N</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="no">age_group</span>]
    <span class="no">size</span> <span class="kw">&lt;-</span> <span class="no">dt</span>[ , <span class="no">.N</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="no">age_group</span>]
    <span class="no">groups</span> <span class="kw">&lt;-</span> <span class="fl">0</span>:<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">dt</span>$<span class="no">age_group</span>)
    <span class="no">ages</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">groups</span>)
    <span class="no">out</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">deaths</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="no">ages</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="no">ages</span>), <span class="kw">age_group</span> <span class="kw">=</span> <span class="no">groups</span>)
    <span class="no">out</span>[<span class="no">size</span>$<span class="no">age_group</span> + <span class="fl">1</span>,<span class="st">"size"</span>] <span class="kw">&lt;-</span> <span class="no">size</span>$<span class="no">N</span>
    <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span>(<span class="no">deaths</span>$<span class="no">N</span> <span class="kw">&gt;</span> <span class="fl">0</span>)) {
        <span class="no">out</span>[<span class="no">deaths</span>$<span class="no">age_group</span> + <span class="fl">1</span>,<span class="st">"deaths"</span>] <span class="kw">&lt;-</span> <span class="no">deaths</span>$<span class="no">N</span>
    }
    <span class="no">out</span> <span class="kw">&lt;-</span> <span class="no">out</span>[<span class="no">out</span>$<span class="no">age_group</span> <span class="kw">&gt;=</span> <span class="no">min_age</span>, ]
    <span class="no">stroke_prop</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">dt</span>[<span class="no">alive</span> <span class="kw">==</span> <span class="fl">0</span> <span class="kw">&amp;</span> <span class="no">has_cardio</span> <span class="kw">==</span> <span class="fl">1</span> <span class="kw">&amp;</span> (<span class="no">age</span> - <span class="no">cardio_disease</span>) <span class="kw">&lt;</span> (<span class="fl">28</span>/<span class="fl">365</span>),]) / <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">dt</span>[<span class="no">alive</span> <span class="kw">==</span> <span class="fl">0</span>,])
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">out</span> <span class="kw">=</span> <span class="no">out</span>, <span class="kw">stroke_prop</span> <span class="kw">=</span> <span class="no">stroke_prop</span>))
}</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Santtu Tikka, Jussi Hakanen, Mirka Saarela, Juha Karvanen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
